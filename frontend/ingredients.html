<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加料 - 四时</title>
    <style>
        @font-face {
            font-family: 'ShuQingGuKaiTi';
            src: url('../assets/ShuQingGuKaiTi-2.ttf') format('truetype');
            font-display: swap;
        }
        html, body, * {
            font-family: 'ShuQingGuKaiTi', serif !important;
        }
        
        :root {
            --primary-red: #60281E;
            --secondary-gold: #DAA520;
            --accent-jade: #478778;
            --warm-beige: #F5F5DC;
            --ink-black: #2C2C2C;
            --paper-white: #FEFEFE;
            --border-gray: #D3D3D3;
            --shadow-dark: rgba(44, 44, 44, 0.2);
            --success-green: #52C41A;
            --warning-orange: #FA8C16;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif SC', serif;
            background: linear-gradient(135deg, var(--warm-beige) 0%, var(--paper-white) 100%);
            color: var(--ink-black);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }

        .back-button {
            padding: 0.8rem 1.5rem;
            background: var(--accent-jade);
            color: var(--paper-white);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid var(--accent-jade);
        }

        .back-button:hover {
            background: transparent;
            color: var(--accent-jade);
            transform: translateY(-2px);
        }

        .location-info {
            background: var(--secondary-gold);
            color: var(--paper-white);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .title-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .dumpling-icon {
            background: url('../assets/3.png') no-repeat center center / contain !important;
            border-radius: 0;
            position: relative;
        }
        .dumpling-icon::after {
            content: none !important;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-red);
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px var(--shadow-dark);
        }

        .page-subtitle {
            font-size: 1.2rem;
            color: var(--accent-jade);
            font-weight: 400;
        }

        .ingredients-section {
            background: var(--paper-white);
            border: 3px solid var(--border-gray);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 4px 4px 12px var(--shadow-dark);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-red);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .common-ingredients {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .ingredient-item {
            background: var(--warm-beige);
            border: 2px solid var(--border-gray);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .ingredient-item:hover {
            transform: translateY(-4px);
            border-color: var(--secondary-gold);
            box-shadow: 0 4px 12px var(--shadow-dark);
        }

        .ingredient-item.selected {
            background: var(--secondary-gold);
            color: var(--paper-white);
            border-color: var(--secondary-gold);
        }

        .ingredient-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .ingredient-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .custom-ingredient {
            margin-top: 1rem;
        }

        .custom-input {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            background: var(--paper-white);
            color: var(--ink-black);
            font-family: 'Noto Serif SC', serif;
            transition: all 0.3s ease;
        }

        .custom-input:focus {
            outline: none;
            border-color: var(--secondary-gold);
            box-shadow: 0 0 8px rgba(218, 165, 32, 0.3);
        }

        .voice-section {
            background: var(--paper-white);
            border: 3px solid var(--border-gray);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 4px 4px 12px var(--shadow-dark);
        }

        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .voice-button {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border: 3px solid var(--border-gray);
            border-radius: 12px;
            background: var(--paper-white);
            color: var(--ink-black);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Serif SC', serif;
            font-weight: 500;
            min-width: 120px;
        }

        .voice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-dark);
        }

        .voice-button.start {
            border-color: var(--success-green);
            color: var(--success-green);
        }

        .voice-button.start:hover, .voice-button.start.active {
            background: var(--success-green);
            color: var(--paper-white);
        }

        .voice-button.stop {
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        .voice-button.stop:hover, .voice-button.stop.active {
            background: var(--primary-red);
            color: var(--paper-white);
        }

        .voice-status {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
            min-height: 1.5rem;
        }

        .voice-status.listening {
            color: var(--success-green);
        }

        .voice-status.processing {
            color: var(--warning-orange);
        }

        .voice-status.success {
            color: var(--success-green);
        }

        .voice-status.error {
            color: var(--primary-red);
        }

        .voice-result {
            background: var(--warm-beige);
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            padding: 1rem;
            min-height: 100px;
            font-size: 1rem;
            line-height: 1.5;
        }

        .warehouse-summary {
            background: var(--accent-jade);
            color: var(--paper-white);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: center;
        }

        .warehouse-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .warehouse-content {
            font-size: 1rem;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .page-title {
                font-size: 2.5rem;
            }
            
            .common-ingredients {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .voice-controls {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../index.html" class="back-button">← 返回首页</a>
            <div class="location-info" id="locationInfo">挪威</div>
        </div>

        <div class="title-section">
            <div class="dumpling-icon"></div>
            <h1 class="page-title">加料</h1>
            <p class="page-subtitle">管理您的调料仓库</p>
        </div>

        <div class="ingredients-section">
            <h2 class="section-title">中餐常见调料</h2>
            <div class="common-ingredients">
                <div class="ingredient-item" onclick="toggleIngredient(this, '盐')">
                    <div class="ingredient-icon" style="background: url('../assets/7.png') no-repeat center center / contain; width: 80px; height: 80px; margin: 0 auto 0.5rem; display: block;"></div>
                    <div class="ingredient-name">盐</div>
                </div>
                <div class="ingredient-item" onclick="toggleIngredient(this, '糖')">
                    <div class="ingredient-icon" style="background: url('../assets/8.png') no-repeat center center / contain; width: 80px; height: 80px; margin: 0 auto 0.5rem; display: block;"></div>
                    <div class="ingredient-name">糖</div>
                </div>
                <div class="ingredient-item" onclick="toggleIngredient(this, '醋')">
                    <div class="ingredient-icon" style="background: url('../assets/9.png') no-repeat center center / contain; width: 80px; height: 80px; margin: 0 auto 0.5rem; display: block;"></div>
                    <div class="ingredient-name">醋</div>
                </div>
                <div class="ingredient-item" onclick="toggleIngredient(this, '酱油')">
                    <div class="ingredient-icon" style="background: url('../assets/10.png') no-repeat center center / contain; width: 80px; height: 80px; margin: 0 auto 0.5rem; display: block;"></div>
                    <div class="ingredient-name">酱油</div>
                </div>
                <div class="ingredient-item" onclick="toggleIngredient(this, '料酒')">
                    <div class="ingredient-icon" style="background: url('../assets/11.png') no-repeat center center / contain; width: 80px; height: 80px; margin: 0 auto 0.5rem; display: block;"></div>
                    <div class="ingredient-name">料酒</div>
                </div>
            </div>
            
            <div class="custom-ingredient">
                <input type="text" class="custom-input" placeholder="输入其他调料名称..." 
                       onkeypress="handleCustomIngredient(event)">
            </div>
        </div>

        <div class="voice-section">
            <h2 class="section-title">语音输入仓库管理</h2>
            <div class="voice-controls">
                <button class="voice-button start" onclick="startVoiceInput()">开始</button>
                <button class="voice-button stop" onclick="stopVoiceInput()">结束</button>
            </div>
            <div class="voice-status" id="voiceStatus">点击"开始"按钮开始语音输入</div>
            <div class="voice-result" id="voiceResult">
                语音识别结果将在这里显示...
                <br><br>
                例如：说 "我有三个西红柿，两根黄瓜，一包面条" 
                <br>
                系统会自动识别并添加到您的仓库中
                <br><br>
                <strong>支持格式：</strong>
                <br>
                • 中文数字：三个西红柿、两根黄瓜
                <br>
                • 阿拉伯数字：3个西红柿、2根黄瓜
                <br>
                • 单位：个、根、包、块、瓶、袋、斤等
            </div>
        </div>

        <div class="warehouse-summary">
            <div class="warehouse-title">
                我的调料仓库
                <button onclick="clearAllIngredients()" class="clear-button" style="float: right; padding: 0.3rem 0.8rem; background: #C7302B; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">清空仓库</button>
            </div>
            <div class="warehouse-content" id="warehouseContent">
                仓库为空，请添加调料...
            </div>
        </div>

        <!-- 测试区域（仅在开发环境显示） -->
        <div id="testArea" style="display: none; margin-top: 2rem; padding: 1rem; background: #f0f0f0; border-radius: 8px;">
            <h3>同义词测试区域</h3>
            <p>测试输入：</p>
            <input type="text" id="testInput" placeholder="输入测试文本，如：三个西红柿，两个番茄" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem;">
            <button onclick="runTest()" style="padding: 0.5rem 1rem; background: #478778; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 1rem;">运行测试</button>
            <button onclick="testClearAll()" style="padding: 0.5rem 1rem; background: #C7302B; color: white; border: none; border-radius: 4px; cursor: pointer;">测试清空功能</button>
            <div id="testResult" style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 4px;"></div>
        </div>
    </div>

    <script src="api-utils.js"></script>
    <script>
        let selectedIngredients = []; // 存储食材名称
        let ingredientQuantities = {}; // 存储食材数量
        let isListening = false;

        // 页面加载时显示用户位置和恢复仓库数据
        window.addEventListener('load', async function() {
            const savedLocation = await api.getUserLocation();
            const locationInfo = document.getElementById('locationInfo');
            
            if (savedLocation) {
                const locationNames = {
                    'norway': '挪威',
                    'sweden': '瑞典',
                    'denmark': '丹麦',
                    'finland': '芬兰',
                    'iceland': '冰岛',
                    'germany': '德国',
                    'netherlands': '荷兰',
                    'france': '法国',
                    'uk': '英国',
                    'other': '欧洲'
                };
                locationInfo.textContent = locationNames[savedLocation] || '未知位置';
            }

            // 恢复已选择的调料
            await loadSavedIngredients();
        });

        function toggleIngredient(element, ingredientName) {
            element.classList.toggle('selected');
            
            // 标准化食材名称
            const normalizedName = normalizeIngredientName(ingredientName);
            
            if (element.classList.contains('selected')) {
                if (!selectedIngredients.includes(normalizedName)) {
                    selectedIngredients.push(normalizedName);
                    ingredientQuantities[normalizedName] = '1个'; // 默认数量
                }
            } else {
                selectedIngredients = selectedIngredients.filter(item => item !== normalizedName);
                delete ingredientQuantities[normalizedName]; // 删除数量记录
            }
            
            updateWarehouseDisplay();
            saveToLocalStorage();
        }

        function handleCustomIngredient(event) {
            if (event.key === 'Enter') {
                const ingredientName = event.target.value.trim();
                if (ingredientName) {
                    // 标准化食材名称
                    const normalizedName = normalizeIngredientName(ingredientName);
                    if (!selectedIngredients.includes(normalizedName)) {
                        selectedIngredients.push(normalizedName);
                        ingredientQuantities[normalizedName] = '1个'; // 默认数量
                        updateWarehouseDisplay();
                        saveToLocalStorage();
                        event.target.value = '';
                    }
                }
            }
        }

        let mediaRecorder = null;
        let audioChunks = [];

        async function startVoiceInput() {
            if (isListening) return;
            
            try {
                // 请求麦克风权限，使用更适合语音识别的音频设置
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                isListening = true;
                const statusElement = document.getElementById('voiceStatus');
                const startButton = document.querySelector('.voice-button.start');
                
                statusElement.textContent = '正在监听中...';
                statusElement.className = 'voice-status listening';
                startButton.classList.add('active');
                
                // 创建MediaRecorder，使用更好的音频格式
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // 检查音频质量
                    if (audioChunks.length === 0) {
                        const statusElement = document.getElementById('voiceStatus');
                        statusElement.textContent = '录音时间太短，请重新录音';
                        statusElement.className = 'voice-status error';
                        stream.getTracks().forEach(track => track.stop());
                        return;
                    }
                    
                    // 转换为百度API要求的格式
                    const convertedBlob = await convertAudioForBaiduAPI(audioBlob);
                    await processVoiceRecognition(convertedBlob);
                    
                    // 停止所有音频轨道
                    stream.getTracks().forEach(track => track.stop());
                };
                
                // 开始录音
                mediaRecorder.start();
                
            } catch (error) {
                console.error('启动语音识别失败:', error);
                const statusElement = document.getElementById('voiceStatus');
                statusElement.textContent = '无法访问麦克风，请检查权限设置';
                statusElement.className = 'voice-status error';
            }
        }

        function stopVoiceInput() {
            if (!isListening || !mediaRecorder) return;
            
            isListening = false;
            const statusElement = document.getElementById('voiceStatus');
            const startButton = document.querySelector('.voice-button.start');
            const stopButton = document.querySelector('.voice-button.stop');
            
            statusElement.textContent = '正在处理语音...';
            statusElement.className = 'voice-status processing';
            startButton.classList.remove('active');
            stopButton.classList.add('active');
            
            // 停止录音
            mediaRecorder.stop();
            
            setTimeout(() => {
                stopButton.classList.remove('active');
            }, 1000);
        }

        async function processVoiceRecognition(audioBlob) {
            try {
                const statusElement = document.getElementById('voiceStatus');
                const resultElement = document.getElementById('voiceResult');
                
                statusElement.textContent = '正在识别语音...';
                statusElement.className = 'voice-status processing';
                
                // 调用语音识别API
                const result = await api.recognizeVoice(audioBlob);
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                const recognizedText = result.text;
                
                // 解析食材和数量
                const parsedIngredients = parseIngredientsFromText(recognizedText);
                
                // 显示识别结果
                resultElement.innerHTML = `
                    <strong>识别结果：</strong>${recognizedText}
                    <br><br>
                    <strong>解析结果：</strong>
                    <br>
                    ${parsedIngredients.map(item => `${item.name}：${item.quantity}`).join('、')}
                `;
                
                // 添加到仓库
                parsedIngredients.forEach(item => {
                    const ingredientName = item.name;
                    if (!selectedIngredients.includes(ingredientName)) {
                        selectedIngredients.push(ingredientName);
                    }
                    
                    // 累加数量而不是覆盖
                    const currentQuantity = ingredientQuantities[ingredientName] || '0个';
                    const newQuantity = item.quantity;
                    
                    // 解析当前数量和新数量
                    const currentNum = parseInt(currentQuantity.match(/\d+/)[0]) || 0;
                    const newNum = parseInt(newQuantity.match(/\d+/)[0]) || 0;
                    
                    // 提取单位，优先使用新数量的单位
                    let unit = '个';
                    const unitMatch = newQuantity.match(/[个包根瓶袋斤克千克公斤片瓣把束盒]/);
                    if (unitMatch) {
                        unit = unitMatch[0];
                    } else {
                        // 如果没有找到单位，尝试从当前数量中提取
                        const currentUnitMatch = currentQuantity.match(/[个包根瓶袋斤克千克公斤片瓣把束盒]/);
                        if (currentUnitMatch) {
                            unit = currentUnitMatch[0];
                        }
                    }
                    
                    // 累加数量
                    const totalNum = currentNum + newNum;
                    ingredientQuantities[ingredientName] = `${totalNum}${unit}`;
                });
                
                updateWarehouseDisplay();
                saveToLocalStorage();
                
                statusElement.textContent = '语音识别完成';
                statusElement.className = 'voice-status success';
                
                setTimeout(() => {
                    statusElement.textContent = '点击"开始"按钮开始语音输入';
                    statusElement.className = 'voice-status';
                }, 3000);
                
            } catch (error) {
                console.error('语音识别失败:', error);
                const statusElement = document.getElementById('voiceStatus');
                const resultElement = document.getElementById('voiceResult');
                
                statusElement.textContent = '语音识别失败，请重试';
                statusElement.className = 'voice-status error';
                
                resultElement.innerHTML = `
                    <strong>识别失败：</strong>${error.message}
                    <br><br>
                    请检查：
                    <br>
                    1. 网络连接是否正常
                    <br>
                    2. 语音是否清晰
                    <br>
                    3. 百度API密钥是否配置正确
                `;
                
                setTimeout(() => {
                    statusElement.textContent = '点击"开始"按钮开始语音输入';
                    statusElement.className = 'voice-status';
                }, 3000);
            }
        }

        async function convertAudioForBaiduAPI(audioBlob) {
            try {
                // 创建AudioContext，使用16kHz采样率
                const audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                
                // 读取音频数据
                const arrayBuffer = await audioBlob.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // 获取音频数据
                const channelData = audioBuffer.getChannelData(0); // 单声道
                
                // 如果采样率不是16kHz，需要重采样
                let processedData = channelData;
                if (audioBuffer.sampleRate !== 16000) {
                    const ratio = 16000 / audioBuffer.sampleRate;
                    const newLength = Math.round(channelData.length * ratio);
                    processedData = new Float32Array(newLength);
                    
                    for (let i = 0; i < newLength; i++) {
                        const oldIndex = Math.floor(i / ratio);
                        processedData[i] = channelData[oldIndex];
                    }
                }
                
                // 转换为16位PCM格式
                const pcmData = new Int16Array(processedData.length);
                for (let i = 0; i < processedData.length; i++) {
                    pcmData[i] = Math.max(-32768, Math.min(32767, processedData[i] * 32768));
                }
                
                // 创建新的Blob
                return new Blob([pcmData.buffer], { type: 'audio/pcm' });
            } catch (error) {
                console.error('音频转换失败:', error);
                // 如果转换失败，返回原始音频
                return audioBlob;
            }
        }

        function parseIngredientsFromText(text) {
            const ingredients = [];
            const foundIngredients = new Set(); // 用于去重
            
            // 数字映射
            const numberMap = {
                '一': 1, '二': 2, '两': 2, '三': 3, '四': 4, '五': 5,
                '六': 6, '七': 7, '八': 8, '九': 9, '十': 10,
                '十一': 11, '十二': 12, '十三': 13, '十四': 14, '十五': 15,
                '十六': 16, '十七': 17, '十八': 18, '十九': 19, '二十': 20
            };
            
            // 食材同义词映射表 - 将同义词统一为标准名称
            const ingredientSynonyms = {
                '西红柿': '番茄',
                '番茄': '番茄',
                '黄瓜': '黄瓜',
                '土豆': '土豆',
                '马铃薯': '土豆',
                '胡萝卜': '胡萝卜',
                '洋葱': '洋葱',
                '大蒜': '大蒜',
                '蒜': '大蒜',
                '姜': '姜',
                '生姜': '姜',
                '葱': '葱',
                '大葱': '葱',
                '白菜': '白菜',
                '菠菜': '菠菜',
                '芹菜': '芹菜',
                '韭菜': '韭菜',
                '香菜': '香菜',
                '辣椒': '辣椒',
                '茄子': '茄子',
                '南瓜': '南瓜',
                '冬瓜': '冬瓜',
                '豆腐': '豆腐',
                '豆芽': '豆芽',
                '豆干': '豆干',
                '腐竹': '腐竹',
                '粉丝': '粉丝',
                '面条': '面条',
                '米饭': '米饭',
                '馒头': '馒头',
                '包子': '包子',
                '鸡蛋': '鸡蛋',
                '鸭蛋': '鸭蛋',
                '鹌鹑蛋': '鹌鹑蛋',
                '鸡肉': '鸡肉',
                '猪肉': '猪肉',
                '牛肉': '牛肉',
                '羊肉': '羊肉',
                '鱼肉': '鱼肉',
                '虾': '虾',
                '生抽': '生抽',
                '老抽': '老抽',
                '蚝油': '蚝油',
                '醋': '醋',
                '盐': '盐',
                '糖': '糖',
                '味精': '味精',
                '鸡精': '鸡精',
                '胡椒粉': '胡椒粉',
                '花椒': '花椒',
                '八角': '八角',
                '桂皮': '桂皮',
                '香叶': '香叶',
                '孜然': '孜然',
                '芝麻': '芝麻',
                '花生': '花生',
                '核桃': '核桃',
                '杏仁': '杏仁'
            };
            
            // 常见食材关键词（使用标准名称）
            const ingredientKeywords = Object.values(ingredientSynonyms);
            
            // 先用逗号（中英文）、顿号、句号、分号等分割句子，提升多食材识别率
            const segments = text.split(/[，,、。；;\n]/);
            
            // 匹配模式：数字 + 单位 + 食材
            const patterns = [
                // 匹配 "三个西红柿" 这种格式
                new RegExp(`([一二三四五六七八九十两]+个|\\d+个)([^，。！？、,;；\s]+)`),
                // 匹配 "三个 西红柿" 这种格式（带空格）
                new RegExp(`([一二三四五六七八九十两]+个|\\d+个)\\s*([^，。！？、,;；\s]+)`),
                // 匹配 "三 个 西红柿" 这种格式（分开）
                new RegExp(`([一二三四五六七八九十两]+)\\s*个\\s*([^，。！？、,;；\s]+)`),
                // 匹配 "3个西红柿" 这种格式
                new RegExp(`(\\d+)\\s*个\\s*([^，。！？、,;；\s]+)`),
                // 匹配 "两包面条" 这种格式
                new RegExp(`([一二三四五六七八九十两]+包|\\d+包)([^，。！？、,;；\s]+)`),
                // 匹配 "两包 面条" 这种格式（带空格）
                new RegExp(`([一二三四五六七八九十两]+包|\\d+包)\\s*([^，。！？、,;；\s]+)`),
                // 匹配 "两 包 面条" 这种格式（分开）
                new RegExp(`([一二三四五六七八九十两]+)\\s*包\\s*([^，。！？、,;；\s]+)`),
                // 匹配 "2包面条" 这种格式
                new RegExp(`(\\d+)\\s*包\\s*([^，。！？、,;；\s]+)`),
                // 匹配 "两根黄瓜" 这种格式
                new RegExp(`([一二三四五六七八九十两]+根|\\d+根)([^，。！？、,;；\s]+)`),
                // 匹配 "两根 黄瓜" 这种格式（带空格）
                new RegExp(`([一二三四五六七八九十两]+根|\\d+根)\\s*([^，。！？、,;；\s]+)`),
                // 匹配 "两 根 黄瓜" 这种格式（分开）
                new RegExp(`([一二三四五六七八九十两]+)\\s*根\\s*([^，。！？、,;；\s]+)`),
                // 匹配 "2根黄瓜" 这种格式
                new RegExp(`(\\d+)\\s*根\\s*([^，。！？、,;；\s]+)`),
                // 匹配 "三 西红柿" 这种格式（省略单位）
                new RegExp(`([一二三四五六七八九十]+)\\s+([^，。！？、,;；\s]+)`),
                // 匹配 "3 西红柿" 这种格式（省略单位）
                new RegExp(`(\\d+)\\s+([^，。！？、,;；\s]+)`)
            ];
            
            // 逐段匹配，提升多食材识别率
            segments.forEach(segment => {
                let matched = false;
                for (const pattern of patterns) {
                    const match = pattern.exec(segment.trim());
                    if (match) {
                        matched = true;
                        const quantityPart = match[1];
                        const ingredient = match[2];
                        let num = 1;
                        let unit = '个';
                        if (numberMap[quantityPart]) {
                            num = numberMap[quantityPart];
                        } else if (quantityPart.includes('个')) {
                            const numStr = quantityPart.replace('个', '');
                            num = numberMap[numStr] || parseInt(numStr) || 1;
                            unit = '个';
                        } else if (quantityPart.includes('包')) {
                            const numStr = quantityPart.replace('包', '');
                            num = numberMap[numStr] || parseInt(numStr) || 1;
                            unit = '包';
                        } else if (quantityPart.includes('根')) {
                            const numStr = quantityPart.replace('根', '');
                            num = numberMap[numStr] || parseInt(numStr) || 1;
                            unit = '根';
                        } else {
                            num = numberMap[quantityPart] || parseInt(quantityPart) || 1;
                            unit = '个';
                        }
                        if (isNaN(num)) num = 1;
                        // 标准化食材名称
                        let normalizedIngredient = ingredient;
                        for (const [synonym, standardName] of Object.entries(ingredientSynonyms)) {
                            if (ingredient.includes(synonym) || synonym.includes(ingredient)) {
                                normalizedIngredient = standardName;
                                break;
                            }
                        }
                        if (ingredientKeywords.includes(normalizedIngredient) && !foundIngredients.has(normalizedIngredient)) {
                            ingredients.push({
                                name: normalizedIngredient,
                                quantity: `${num}${unit}`
                            });
                            foundIngredients.add(normalizedIngredient);
                        }
                        break; // 当前段只取第一个匹配，防止重复
                    }
                }
                // 如果没有匹配到数量，尝试匹配单独的食材名称（不break，全部遍历）
                if (!matched) {
                    for (const [synonym, standardName] of Object.entries(ingredientSynonyms)) {
                        if (segment.includes(synonym) && !foundIngredients.has(standardName)) {
                            ingredients.push({
                                name: standardName,
                                quantity: '1个'
                            });
                            foundIngredients.add(standardName);
                        }
                    }
                }
            });
            return ingredients;
        }

        // 标准化食材名称函数
        function normalizeIngredientName(ingredientName) {
            // 食材同义词映射表 - 将同义词统一为标准名称
            const ingredientSynonyms = {
                '西红柿': '番茄',
                '番茄': '番茄',
                '黄瓜': '黄瓜',
                '土豆': '土豆',
                '马铃薯': '土豆',
                '胡萝卜': '胡萝卜',
                '洋葱': '洋葱',
                '大蒜': '大蒜',
                '蒜': '大蒜',
                '姜': '姜',
                '生姜': '姜',
                '葱': '葱',
                '大葱': '葱',
                '白菜': '白菜',
                '菠菜': '菠菜',
                '芹菜': '芹菜',
                '韭菜': '韭菜',
                '香菜': '香菜',
                '辣椒': '辣椒',
                '茄子': '茄子',
                '南瓜': '南瓜',
                '冬瓜': '冬瓜',
                '豆腐': '豆腐',
                '豆芽': '豆芽',
                '豆干': '豆干',
                '腐竹': '腐竹',
                '粉丝': '粉丝',
                '面条': '面条',
                '米饭': '米饭',
                '馒头': '馒头',
                '包子': '包子',
                '鸡蛋': '鸡蛋',
                '鸭蛋': '鸭蛋',
                '鹌鹑蛋': '鹌鹑蛋',
                '鸡肉': '鸡肉',
                '猪肉': '猪肉',
                '牛肉': '牛肉',
                '羊肉': '羊肉',
                '鱼肉': '鱼肉',
                '虾': '虾',
                '生抽': '生抽',
                '老抽': '老抽',
                '蚝油': '蚝油',
                '醋': '醋',
                '盐': '盐',
                '糖': '糖',
                '味精': '味精',
                '鸡精': '鸡精',
                '胡椒粉': '胡椒粉',
                '花椒': '花椒',
                '八角': '八角',
                '桂皮': '桂皮',
                '香叶': '香叶',
                '孜然': '孜然',
                '芝麻': '芝麻',
                '花生': '花生',
                '核桃': '核桃',
                '杏仁': '杏仁'
            };
            
            // 查找同义词映射
            for (const [synonym, standardName] of Object.entries(ingredientSynonyms)) {
                if (ingredientName === synonym || ingredientName.includes(synonym) || synonym.includes(ingredientName)) {
                    return standardName;
                }
            }
            
            // 如果没有找到映射，返回原名称
            return ingredientName;
        }

        // 测试函数：验证同义词映射
        function testIngredientSynonyms() {
            console.log('测试同义词映射功能：');
            
            const testCases = [
                '三个西红柿',
                '两个番茄',
                '一根黄瓜',
                '两根黄瓜',
                '两个马铃薯',
                '三瓣蒜',
                '一块生姜',
                '我买了一个苹果，两个香蕉'
            ];
            
            testCases.forEach(testCase => {
                const result = parseIngredientsFromText(testCase);
                console.log(`输入: "${testCase}" -> 输出:`, result);
            });
            
            console.log('测试标准化函数：');
            const normalizeTests = ['西红柿', '番茄', '马铃薯', '蒜', '生姜'];
            normalizeTests.forEach(test => {
                console.log(`标准化 "${test}" -> "${normalizeIngredientName(test)}"`);
            });
        }

        // 测试函数
        function runTest() {
            const testInput = document.getElementById('testInput').value;
            const testResult = document.getElementById('testResult');
            
            if (!testInput.trim()) {
                testResult.innerHTML = '<strong>请输入测试文本</strong>';
                return;
            }
            
            const result = parseIngredientsFromText(testInput);
            testResult.innerHTML = `
                <strong>测试结果：</strong><br>
                输入: "${testInput}"<br>
                解析结果: ${result.map(item => `${item.name}：${item.quantity}`).join('、')}<br>
                标准化名称: ${result.map(item => item.name).join('、')}
            `;
        }

        // 测试清空功能
        async function testClearAll() {
            const testResult = document.getElementById('testResult');
            testResult.innerHTML = '<strong>测试清空功能：</strong><br>';
            
            try {
                // 先添加一些测试数据
                testResult.innerHTML += '1. 添加测试食材...<br>';
                await api.addUserIngredients(['测试食材1', '测试食材2', '测试食材3']);
                
                // 获取当前食材
                testResult.innerHTML += '2. 获取当前食材...<br>';
                const currentIngredients = await api.getUserIngredients();
                testResult.innerHTML += `当前食材数量: ${currentIngredients.length}<br>`;
                
                // 清空所有食材
                testResult.innerHTML += '3. 清空所有食材...<br>';
                await api.clearAllUserIngredients();
                
                // 验证清空结果
                testResult.innerHTML += '4. 验证清空结果...<br>';
                const clearedIngredients = await api.getUserIngredients();
                testResult.innerHTML += `清空后食材数量: ${clearedIngredients.length}<br>`;
                
                testResult.innerHTML += '<strong style="color: green;">✅ 清空功能测试成功！</strong>';
                
            } catch (error) {
                testResult.innerHTML += `<strong style="color: red;">❌ 测试失败: ${error.message}</strong>`;
                console.error('测试清空功能失败:', error);
            }
        }

        // 页面加载时运行测试（仅在开发环境）
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            setTimeout(() => {
                testIngredientSynonyms();
                document.getElementById('testArea').style.display = 'block';
            }, 1000);
        }

        function updateWarehouseDisplay() {
            const warehouseContent = document.getElementById('warehouseContent');
            
            if (selectedIngredients.length === 0) {
                warehouseContent.textContent = '您还没有添加任何调料，请选择常用调料或使用语音输入功能';
            } else {
                warehouseContent.innerHTML = `
                    <strong>当前拥有：</strong>
                    <br>
                    ${selectedIngredients.map(ingredient => {
                        const quantity = ingredientQuantities[ingredient] || '1个';
                        return `${ingredient}：${quantity}`;
                    }).join('、')}
                    <br><br>
                    <small>共 ${selectedIngredients.length} 种调料和食材</small>
                `;
            }
        }

        // 加载保存的食材
        async function loadSavedIngredients() {
            try {
                const savedIngredients = await api.getUserIngredients();
                selectedIngredients = savedIngredients.map(item => item.name);
                
                // 恢复数量信息（从数据库加载的默认为1个）
                selectedIngredients.forEach(ingredient => {
                    ingredientQuantities[ingredient] = '1个';
                });
                
                updateWarehouseDisplay();
                // 不再自动高亮顶部按钮，保持所有按钮未选中
            } catch (error) {
                console.error('加载保存的食材失败:', error);
            }
        }

        // 保存食材到数据库
        async function saveToLocalStorage() {
            try {
                await api.addUserIngredients(selectedIngredients);
            } catch (error) {
                console.error('保存食材失败:', error);
            }
        }

        // 清除所有食材
        async function clearAllIngredients() {
            if (confirm('确定要清空仓库中的所有食材吗？此操作不可撤销。')) {
                try {
                    // 清除前端数据
                    selectedIngredients = [];
                    ingredientQuantities = {};
                    
                    // 清除数据库中的数据
                    await api.clearAllUserIngredients();
                    
                    // 更新显示
                    updateWarehouseDisplay();
                    
                    // 清除所有选中状态
                    document.querySelectorAll('.ingredient-item.selected').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    alert('仓库已清空！');
                } catch (error) {
                    console.error('清空食材失败:', error);
                    alert('清空失败，请重试');
                }
            }
        }
    </script>
</body>
</html>